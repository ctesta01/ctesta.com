<p><img src="/assets/img/2023-06-10/interactive_map_scaling.gif" alt="" /></p>

<p>Something I’ve wanted to accomplish for a while is producing interactive
maps in R that provide a higher level of resolution as the user zooms
in.</p>

<p>I’ve finally sat down and accomplished that, and I’m quite happy to be
sharing the R code here.</p>

<p>Since I live in the Boston area and have family in the New York area, I
thought those were great examples to start with, but the code should be
easily adaptable to any US state or locale that has data collected in
the American Community Survey.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># dependencies</span><span class="w">
</span><span class="n">require</span><span class="p">(</span><span class="n">leaflet</span><span class="p">)</span><span class="w">
</span><span class="n">require</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidycensus</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">tidyr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">magrittr</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">leafpop</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">htmlwidgets</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">leaflet.extras</span><span class="p">)</span><span class="w">

</span><span class="n">options</span><span class="p">(</span><span class="n">tigris_use_cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># median income, age, and pct in poverty in Boston Area ---------------------------------------------------</span><span class="w">

</span><span class="c1"># download county data</span><span class="w">
</span><span class="n">ma_counties</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_acs</span><span class="p">(</span><span class="w">
  </span><span class="n">geography</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"county"</span><span class="p">,</span><span class="w">
  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MA"</span><span class="p">,</span><span class="w">
  </span><span class="n">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="w">
    </span><span class="n">median_income</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B19013_001"</span><span class="p">,</span><span class="w">
    </span><span class="n">median_age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B01002_001"</span><span class="p">,</span><span class="w">
    </span><span class="n">total_for_poverty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B17101_001"</span><span class="p">,</span><span class="w">
    </span><span class="n">in_poverty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B17101_002"</span><span class="w">
  </span><span class="p">),</span><span class="w"> 
  </span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2021</span><span class="p">,</span><span class="w">
  </span><span class="n">geometry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c1"># download tract data</span><span class="w">
</span><span class="n">ma_tracts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_acs</span><span class="p">(</span><span class="w">
  </span><span class="n">geography</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"tract"</span><span class="p">,</span><span class="w">
  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MA"</span><span class="p">,</span><span class="w">
  </span><span class="n">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="w">
    </span><span class="n">median_income</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B19013_001"</span><span class="p">,</span><span class="w">
    </span><span class="n">median_age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B01002_001"</span><span class="p">,</span><span class="w">
    </span><span class="n">total_for_poverty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B17101_001"</span><span class="p">,</span><span class="w">
    </span><span class="n">in_poverty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B17101_002"</span><span class="w">
  </span><span class="p">),</span><span class="w"> 
  </span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2021</span><span class="p">,</span><span class="w">
  </span><span class="n">geometry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c1"># download block group data</span><span class="w">
</span><span class="n">ma_block_groups</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_acs</span><span class="p">(</span><span class="w">
  </span><span class="n">geography</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"block group"</span><span class="p">,</span><span class="w">
  </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"MA"</span><span class="p">,</span><span class="w">
  </span><span class="n">variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="w">
    </span><span class="n">median_income</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B19013_001"</span><span class="p">,</span><span class="w">
    </span><span class="n">median_age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B01002_001"</span><span class="p">,</span><span class="w">
    </span><span class="n">total_for_poverty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B17101_001"</span><span class="p">,</span><span class="w">
    </span><span class="n">in_poverty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"B17101_002"</span><span class="w">
  </span><span class="p">),</span><span class="w"> 
  </span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2021</span><span class="p">,</span><span class="w">
  </span><span class="n">geometry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="c1"># put the data together in a list</span><span class="w">
</span><span class="n">ma_geographic_dfs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="w">
  </span><span class="n">counties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_counties</span><span class="p">,</span><span class="w">
  </span><span class="n">tracts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_tracts</span><span class="p">,</span><span class="w">
  </span><span class="n">block_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_block_groups</span><span class="w">
</span><span class="p">)</span><span class="w">


</span><span class="c1"># pivot the data wider</span><span class="w">
</span><span class="n">ma_geographic_dfs</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">purrr</span><span class="o">::</span><span class="n">map</span><span class="p">(</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">tidyr</span><span class="o">::</span><span class="n">pivot_wider</span><span class="p">(</span><span class="w">
  </span><span class="n">.</span><span class="p">,</span><span class="w">
  </span><span class="n">id_cols</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'GEOID'</span><span class="p">,</span><span class="w"> </span><span class="s1">'NAME'</span><span class="p">),</span><span class="w">
  </span><span class="n">names_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'variable'</span><span class="p">,</span><span class="w">
  </span><span class="n">values_from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'estimate'</span><span class="w">
</span><span class="p">))</span><span class="w">

</span><span class="c1"># calculate the pct in poverty from last 12 months of household income poverty threshold data</span><span class="w">
</span><span class="n">ma_geographic_dfs</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">purrr</span><span class="o">::</span><span class="n">map</span><span class="p">(</span><span class="w"> </span><span class="o">~</span><span class="w"> </span><span class="n">mutate</span><span class="p">(</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">pct_in_poverty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in_poverty</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">total_for_poverty</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">100</span><span class="p">))</span><span class="w">

</span><span class="c1"># add geography data to each: </span><span class="w">
</span><span class="c1"># we held off on doing this in the `tidycensus::get_acs` calls because sf objects </span><span class="w">
</span><span class="c1"># often interact poorly with `tidyr::pivot_wider`</span><span class="w">
</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">counties</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="w">
    </span><span class="n">tigris</span><span class="o">::</span><span class="n">counties</span><span class="p">(</span><span class="w">
      </span><span class="n">cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w">
      </span><span class="n">resolution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'20m'</span><span class="p">,</span><span class="w">
      </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'MA'</span><span class="w">
    </span><span class="p">),</span><span class="w">
    </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">counties</span><span class="p">,</span><span class="w">
    </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'GEOID'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'GEOID'</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w">

</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">tracts</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="w">
    </span><span class="n">tigris</span><span class="o">::</span><span class="n">tracts</span><span class="p">(</span><span class="n">cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'MA'</span><span class="p">),</span><span class="w">
    </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">tracts</span><span class="p">,</span><span class="w">
    </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'GEOID'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'GEOID'</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w">

</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="w"> </span><span class="o">&lt;-</span><span class="w">
  </span><span class="n">left_join</span><span class="p">(</span><span class="w">
    </span><span class="n">tigris</span><span class="o">::</span><span class="n">block_groups</span><span class="p">(</span><span class="n">cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'MA'</span><span class="p">),</span><span class="w">
    </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">,</span><span class="w">
    </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'GEOID'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'GEOID'</span><span class="p">)</span><span class="w">
  </span><span class="p">)</span><span class="w">


</span><span class="c1"># this formatter is so that the data we show in the `leafpop::popupTable` renders nicely </span><span class="w">
</span><span class="n">custom_formatter</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
  
  </span><span class="c1"># use the scales::*_format functions to provide nice formatting</span><span class="w">
  </span><span class="n">df</span><span class="o">$</span><span class="n">median_income</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">scales</span><span class="o">::</span><span class="n">dollar_format</span><span class="p">()()</span><span class="w">
  </span><span class="n">df</span><span class="o">$</span><span class="n">median_age</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">scales</span><span class="o">::</span><span class="n">number_format</span><span class="p">()()</span><span class="w">
  </span><span class="n">df</span><span class="o">$</span><span class="n">pct_in_poverty</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">scales</span><span class="o">::</span><span class="n">percent_format</span><span class="p">(</span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">accuracy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">.1</span><span class="p">)()</span><span class="w">

  </span><span class="c1"># we don't want to be sending lists of boundary coordinates into the popupTable</span><span class="w">
  </span><span class="n">df</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">sf</span><span class="o">::</span><span class="n">st_drop_geometry</span><span class="p">()</span><span class="w">
  
  </span><span class="c1"># some quick renaming &amp; selection of only important variables</span><span class="w">
  </span><span class="n">df</span><span class="w"> </span><span class="o">%&lt;&gt;%</span><span class="w"> </span><span class="n">select</span><span class="p">(</span><span class="w">
    </span><span class="n">GEOID</span><span class="p">,</span><span class="w">
    </span><span class="n">NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NAME.y</span><span class="p">,</span><span class="w">
    </span><span class="n">`Median Age`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">median_age</span><span class="p">,</span><span class="w">
    </span><span class="n">`Median Income`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">median_income</span><span class="p">,</span><span class="w">
    </span><span class="n">`Poverty`</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pct_in_poverty</span><span class="w">
  </span><span class="p">)</span><span class="w">

  </span><span class="nf">return</span><span class="p">(</span><span class="n">df</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># we'll use Blues for the income level</span><span class="w">
</span><span class="n">income_pal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorNumeric</span><span class="p">(</span><span class="s2">"Blues"</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="o">$</span><span class="n">median_income</span><span class="p">,</span><span class="w"> </span><span class="n">na.color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w">

</span><span class="n">leaflet</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">providers</span><span class="o">$</span><span class="n">CartoDB.Voyager</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addPolygons</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">counties</span><span class="p">,</span><span class="w">
    </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">income_pal</span><span class="p">(</span><span class="n">median_income</span><span class="p">),</span><span class="w">
    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'counties'</span><span class="p">,</span><span class="w">
    </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafpop</span><span class="o">::</span><span class="n">popupTable</span><span class="p">(</span><span class="n">custom_formatter</span><span class="p">(</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">counties</span><span class="p">),</span><span class="w"> </span><span class="n">row.numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addPolygons</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">tracts</span><span class="p">,</span><span class="w">
    </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">income_pal</span><span class="p">(</span><span class="n">median_income</span><span class="p">),</span><span class="w">
    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'tracts'</span><span class="p">,</span><span class="w">
    </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafpop</span><span class="o">::</span><span class="n">popupTable</span><span class="p">(</span><span class="n">custom_formatter</span><span class="p">(</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">tracts</span><span class="p">),</span><span class="w"> </span><span class="n">row.numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addPolygons</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">,</span><span class="w">
    </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">income_pal</span><span class="p">(</span><span class="n">median_income</span><span class="p">),</span><span class="w">
    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'block groups'</span><span class="p">,</span><span class="w">
    </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafpop</span><span class="o">::</span><span class="n">popupTable</span><span class="p">(</span><span class="n">custom_formatter</span><span class="p">(</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">),</span><span class="w"> </span><span class="n">row.numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addLegend</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">,</span><span class="w">
    </span><span class="n">pal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">income_pal</span><span class="p">,</span><span class="w">
    </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">median_income</span><span class="p">,</span><span class="w">
    </span><span class="n">opacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Median Income $"</span><span class="p">,</span><span class="w">
    </span><span class="n">labFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelFormat</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">"$"</span><span class="p">),</span><span class="w">
    </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomright"</span><span class="w">
  </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addFullscreenControl</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">groupOptions</span><span class="p">(</span><span class="s2">"block groups"</span><span class="p">,</span><span class="w"> </span><span class="n">zoomLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span><span class="o">:</span><span class="m">20</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="c1"># this is where the magic (scale/zoom dependent rendering happens)</span><span class="w">
  </span><span class="n">groupOptions</span><span class="p">(</span><span class="s2">"tracts"</span><span class="p">,</span><span class="w"> </span><span class="n">zoomLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="o">:</span><span class="m">12</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">groupOptions</span><span class="p">(</span><span class="s2">"counties"</span><span class="p">,</span><span class="w"> </span><span class="n">zoomLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">9</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">ma_income_map</span><span class="w">

</span><span class="n">htmlwidgets</span><span class="o">::</span><span class="n">saveWidget</span><span class="p">(</span><span class="n">ma_income_map</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ma_income_map.html"</span><span class="p">,</span><span class="w"> </span><span class="n">selfcontained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<iframe src="/assets/2023-06-10-scale-dependent-maps/ma_income_map.html" width="100%" height="350px"> </iframe>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">poverty_pal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorNumeric</span><span class="p">(</span><span class="s2">"Reds"</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="o">$</span><span class="n">pct_in_poverty</span><span class="p">,</span><span class="w"> </span><span class="n">na.color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w">

</span><span class="n">leaflet</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">providers</span><span class="o">$</span><span class="n">CartoDB.Voyager</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addPolygons</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">counties</span><span class="p">,</span><span class="w">
    </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">poverty_pal</span><span class="p">(</span><span class="n">pct_in_poverty</span><span class="p">),</span><span class="w">
    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'counties'</span><span class="p">,</span><span class="w">
    </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafpop</span><span class="o">::</span><span class="n">popupTable</span><span class="p">(</span><span class="n">custom_formatter</span><span class="p">(</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">counties</span><span class="p">),</span><span class="w"> </span><span class="n">row.numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addPolygons</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">tracts</span><span class="p">,</span><span class="w">
    </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">poverty_pal</span><span class="p">(</span><span class="n">pct_in_poverty</span><span class="p">),</span><span class="w">
    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'tracts'</span><span class="p">,</span><span class="w">
    </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafpop</span><span class="o">::</span><span class="n">popupTable</span><span class="p">(</span><span class="n">custom_formatter</span><span class="p">(</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">tracts</span><span class="p">),</span><span class="w"> </span><span class="n">row.numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addPolygons</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">,</span><span class="w">
    </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">poverty_pal</span><span class="p">(</span><span class="n">pct_in_poverty</span><span class="p">),</span><span class="w">
    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'block groups'</span><span class="p">,</span><span class="w">
    </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafpop</span><span class="o">::</span><span class="n">popupTable</span><span class="p">(</span><span class="n">custom_formatter</span><span class="p">(</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">),</span><span class="w"> </span><span class="n">row.numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addLegend</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">,</span><span class="w">
    </span><span class="n">pal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">poverty_pal</span><span class="p">,</span><span class="w">
    </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">pct_in_poverty</span><span class="p">,</span><span class="w">
    </span><span class="n">opacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"% in Poverty"</span><span class="p">,</span><span class="w">
    </span><span class="n">labFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">labelFormat</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s2">"%"</span><span class="p">),</span><span class="w">
    </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomright"</span><span class="w">
  </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addFullscreenControl</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">groupOptions</span><span class="p">(</span><span class="s2">"block groups"</span><span class="p">,</span><span class="w"> </span><span class="n">zoomLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span><span class="o">:</span><span class="m">20</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">groupOptions</span><span class="p">(</span><span class="s2">"tracts"</span><span class="p">,</span><span class="w"> </span><span class="n">zoomLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="o">:</span><span class="m">12</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">groupOptions</span><span class="p">(</span><span class="s2">"counties"</span><span class="p">,</span><span class="w"> </span><span class="n">zoomLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">9</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">ma_poverty_map</span><span class="w">

</span><span class="n">htmlwidgets</span><span class="o">::</span><span class="n">saveWidget</span><span class="p">(</span><span class="n">ma_poverty_map</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ma_poverty_map.html"</span><span class="p">,</span><span class="w"> </span><span class="n">selfcontained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<iframe src="/assets/2023-06-10-scale-dependent-maps/ma_poverty_map.html" width="100%" height="350px"> </iframe>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">age_pal</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">colorNumeric</span><span class="p">(</span><span class="s2">"magma"</span><span class="p">,</span><span class="w"> </span><span class="n">domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="o">$</span><span class="n">median_age</span><span class="p">,</span><span class="w"> </span><span class="n">na.color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">reverse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="n">leaflet</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addProviderTiles</span><span class="p">(</span><span class="n">providers</span><span class="o">$</span><span class="n">CartoDB.Voyager</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addPolygons</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">counties</span><span class="p">,</span><span class="w">
    </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">age_pal</span><span class="p">(</span><span class="n">median_age</span><span class="p">),</span><span class="w">
    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'counties'</span><span class="p">,</span><span class="w">
    </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafpop</span><span class="o">::</span><span class="n">popupTable</span><span class="p">(</span><span class="n">custom_formatter</span><span class="p">(</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">counties</span><span class="p">),</span><span class="w"> </span><span class="n">row.numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addPolygons</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">tracts</span><span class="p">,</span><span class="w">
    </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">age_pal</span><span class="p">(</span><span class="n">median_age</span><span class="p">),</span><span class="w">
    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'tracts'</span><span class="p">,</span><span class="w">
    </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafpop</span><span class="o">::</span><span class="n">popupTable</span><span class="p">(</span><span class="n">custom_formatter</span><span class="p">(</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">tracts</span><span class="p">),</span><span class="w"> </span><span class="n">row.numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addPolygons</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">,</span><span class="w">
    </span><span class="n">fillColor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">age_pal</span><span class="p">(</span><span class="n">median_age</span><span class="p">),</span><span class="w">
    </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w">
    </span><span class="n">color</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"white"</span><span class="p">,</span><span class="w">
    </span><span class="n">fillOpacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">group</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'block groups'</span><span class="p">,</span><span class="w">
    </span><span class="n">popup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">leafpop</span><span class="o">::</span><span class="n">popupTable</span><span class="p">(</span><span class="n">custom_formatter</span><span class="p">(</span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">),</span><span class="w"> </span><span class="n">row.numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">F</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addLegend</span><span class="p">(</span><span class="w">
    </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ma_geographic_dfs</span><span class="o">$</span><span class="n">block_groups</span><span class="p">,</span><span class="w">
    </span><span class="n">pal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">age_pal</span><span class="p">,</span><span class="w">
    </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">~</span><span class="n">median_age</span><span class="p">,</span><span class="w">
    </span><span class="n">opacity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w">
    </span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Median Age"</span><span class="p">,</span><span class="w">
    </span><span class="n">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"bottomright"</span><span class="w">
  </span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">addFullscreenControl</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">groupOptions</span><span class="p">(</span><span class="s2">"block groups"</span><span class="p">,</span><span class="w"> </span><span class="n">zoomLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span><span class="o">:</span><span class="m">20</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">groupOptions</span><span class="p">(</span><span class="s2">"tracts"</span><span class="p">,</span><span class="w"> </span><span class="n">zoomLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="o">:</span><span class="m">12</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">groupOptions</span><span class="p">(</span><span class="s2">"counties"</span><span class="p">,</span><span class="w"> </span><span class="n">zoomLevels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="m">9</span><span class="p">)</span><span class="w">  </span><span class="o">-&gt;</span><span class="w">
  </span><span class="n">ma_age_map</span><span class="w">

</span><span class="n">htmlwidgets</span><span class="o">::</span><span class="n">saveWidget</span><span class="p">(</span><span class="n">ma_age_map</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ma_age_map.html"</span><span class="p">,</span><span class="w"> </span><span class="n">selfcontained</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<iframe src="/assets/2023-06-10-scale-dependent-maps/ma_age_map.html" width="100%" height="350px"> </iframe>

